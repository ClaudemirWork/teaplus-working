'use client';

import React, { useState, useEffect, useCallback, useRef } from 'react';
import Image from 'next/image';
import { Volume2, VolumeX, Play, RotateCcw, Trophy, Star, Sparkles, Heart, Zap, Gift } from 'lucide-react';
import './auditory-memory.css';

interface GameStats {
ย level: number;
ย score: number;
ย highScore: number;
ย coins: number;
ย combo: number;
ย lives: number;
}

const AuditoryMemoryGame: React.FC = () => {
ย // ===== ESTADOS DO JOGO (COM NOVA LรGICA DE TELAS) =====
ย const [currentScreen, setCurrentScreen] = useState<'titleScreen' | 'instructions' | 'game'>('titleScreen');
ย const [gameState, setGameState] = useState<'idle' | 'playing' | 'listening' | 'success' | 'fail'>('idle');
ย const [sequence, setSequence] = useState<number[]>([]);
ย const [userSequence, setUserSequence] = useState<number[]>([]);
ย const [currentNote, setCurrentNote] = useState<number | null>(null);
ย const [isPlaying, setIsPlaying] = useState(false);
ย const [soundEnabled, setSoundEnabled] = useState(true);
ย const [showSuccess, setShowSuccess] = useState(false);
ย const [showError, setShowError] = useState(false);
ย const [showCombo, setShowCombo] = useState(false);
ย const [showTreasure, setShowTreasure] = useState(false);
ย const [confettiActive, setConfettiActive] = useState(false);
ย const [coinsRaining, setCoinsRaining] = useState(false);
ยย
ย // Estatรญsticas
ย const [stats, setStats] = useState<GameStats>({
ย ย level: 1,
ย ย score: 0,
ย ย highScore: 0,
ย ย coins: 0,
ย ย combo: 0,
ย ย lives: 3
ย });

ย // Configuraรงรฃo do jogo
ย const [sequenceLength, setSequenceLength] = useState(3);
ย const [playbackSpeed, setPlaybackSpeed] = useState(800);
ยย
ย // Referรชncias de รกudio
ย const audioContextRef = useRef<AudioContext | null>(null);
ยย
ย // Cores e frequรชncias dos botรตes
ย const buttons = [
ย ย { color: 'btn-red', emoji: '๐ต', freq: 261.63, name: 'Dร' },
ย ย { color: 'btn-orange', emoji: '๐ถ', freq: 293.66, name: 'Rร' },
ย ย { color: 'btn-yellow', emoji: '๐ผ', freq: 329.63, name: 'MI' },
ย ย { color: 'btn-green', emoji: '๐น', freq: 392.00, name: 'Fร' },
ย ย { color: 'btn-blue', emoji: '๐ธ', freq: 440.00, name: 'SOL' },
ย ย { color: 'btn-purple', emoji: '๐บ', freq: 523.25, name: 'Lร' }
ย ];

  // ===== TODA A LรGICA DE JOGABILIDADE ABAIXO PERMANECE A MESMA =====
ย // (Funรงรตes como playNote, generateSequence, playSequence, handleSuccess, etc. nรฃo foram alteradas)

ย // Inicializar รกudio
ย useEffect(() => {
ย ย if (typeof window !== 'undefined') {
ย ย ย audioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)();
ย ย ยย
ย ย ย const savedHighScore = localStorage.getItem('memoriaSonoraHighScore');
ย ย ย const savedCoins = localStorage.getItem('memoriaSonoraCoins');
ย ย ยย
ย ย ย if (savedHighScore) {
ย ย ย ย setStats(prev => ({ ...prev, highScore: parseInt(savedHighScore) }));
ย ย ย }
ย ย ย if (savedCoins) {
ย ย ย ย setStats(prev => ({ ...prev, coins: parseInt(savedCoins) }));
ย ย ย }
ย ย }

ย ย return () => {
ย ย ย if (audioContextRef.current) {
ย ย ย ย audioContextRef.current.close();
ย ย ย }
ย ย };
ย }, []);

ย // Tocar nota musical
ย const playNote = useCallback((frequency: number, duration: number = 400) => {
ย ย if (!soundEnabled || !audioContextRef.current) return;
ย ย const oscillator = audioContextRef.current.createOscillator();
ย ย const gainNode = audioContextRef.current.createGain();
ย ย oscillator.type = 'sine';
ย ย oscillator.frequency.setValueAtTime(frequency, audioContextRef.current.currentTime);
ย ย oscillator.connect(gainNode);
ย ย gainNode.connect(audioContextRef.current.destination);
ย ย gainNode.gain.setValueAtTime(0, audioContextRef.current.currentTime);
ย ย gainNode.gain.linearRampToValueAtTime(0.3, audioContextRef.current.currentTime + 0.01);
ย ย gainNode.gain.exponentialRampToValueAtTime(0.01, audioContextRef.current.currentTime + duration / 1000);
ย ย oscillator.start(audioContextRef.current.currentTime);
ย ย oscillator.stop(audioContextRef.current.currentTime + duration / 1000);
ย }, [soundEnabled]);

ย // Gerar nova sequรชncia
ย const generateSequence = useCallback(() => {
ย ย const newSequence = Array.from({ length: sequenceLength }, () => Math.floor(Math.random() * 6));
ย ย setSequence(newSequence);
ย ย return newSequence;
ย }, [sequenceLength]);

ย // Tocar sequรชncia
ย const playSequence = useCallback(async (seq: number[]) => {
ย ย setIsPlaying(true);
ย ย setGameState('listening');
ย ย await new Promise(resolve => setTimeout(resolve, 500));
ย ย for (let i = 0; i < seq.length; i++) {
ย ย ย setCurrentNote(seq[i]);
ย ย ย playNote(buttons[seq[i]].freq, 400);
ย ย ย await new Promise(resolve => setTimeout(resolve, playbackSpeed));
ย ย ย setCurrentNote(null);
ย ย ย if (i < seq.length - 1) {
ย ย ย ย await new Promise(resolve => setTimeout(resolve, 100));
ย ย ย }
ย ย }
ย ย setIsPlaying(false);
ย ย setGameState('playing');
ย ย setUserSequence([]);
ย }, [playNote, buttons, playbackSpeed]);

ย // Iniciar jogo
ย const startGame = useCallback(() => {
    // Agora o jogo comeรงa de verdade aqui
    setCurrentScreen('game');
    setGameState('idle'); // Inicia em idle para o jogador clicar em 'comeรงar' no painel
ย }, []);
  
  // Funรงรฃo para comeรงar a primeira rodada
  const startFirstRound = () => {
    const newSequence = generateSequence();
ย ย setUserSequence([]);
ย ย setShowSuccess(false);
ย ย setShowError(false);
ย ย playSequence(newSequence);
  }

ย // Verificar clique do usuรกrio
ย const handleNoteClick = useCallback((noteIndex: number) => {
ย ย if (gameState !== 'playing' || isPlaying) return;
ย ย playNote(buttons[noteIndex].freq, 300);
ย ย const newUserSequence = [...userSequence, noteIndex];
ย ย setUserSequence(newUserSequence);
ย ย setCurrentNote(noteIndex);
ย ย setTimeout(() => setCurrentNote(null), 300);
ย ยย
ย ย if (newUserSequence.length === sequence.length) {
ย ย ย const isCorrect = newUserSequence.every((note, index) => note === sequence[index]);
ย ย ย setTimeout(() => {
ย ย ย ย if (isCorrect) {
ย ย ย ย ย handleSuccess();
ย ย ย ย } else {
ย ย ย ย ย handleFailure();
ย ย ย ย }
ย ย ย }, 400);
ย ย }
ย }, [gameState, isPlaying, userSequence, sequence, playNote, buttons]);

ย // Sucesso
ย const handleSuccess = useCallback(() => {
ย ย setGameState('success');
ย ย setShowSuccess(true);
ย ย const basePoints = sequenceLength * 10;
ย ย const comboBonus = stats.combo * 5;
ย ย const totalPoints = (basePoints + comboBonus) * stats.level;
ย ย const newCombo = stats.combo + 1;
ย ย const newScore = stats.score + totalPoints;
ย ย const newHighScore = Math.max(newScore, stats.highScore);
ย ยย
ย ย setStats(prev => ({ ...prev, score: newScore, highScore: newHighScore, combo: newCombo, coins: prev.coins + 10 }));
ย ย localStorage.setItem('memoriaSonoraHighScore', newHighScore.toString());
ย ย localStorage.setItem('memoriaSonoraCoins', (stats.coins + 10).toString());
ย ยย
ย ย if (newCombo >= 3) {
ย ย ย setConfettiActive(true);
      setTimeout(() => setConfettiActive(false), 3000);
ย ย }
ย ยย
ย ย setTimeout(() => {
ย ย ย setShowSuccess(false);
ย ย ย const newLevel = stats.level + 1;
ย ย ย setStats(prev => ({ ...prev, level: newLevel }));
ย ย ย if (newLevel % 3 === 0) setSequenceLength(prev => Math.min(prev + 1, 12));
ย ย ย if (newLevel % 5 === 0) setPlaybackSpeed(prev => Math.max(prev - 50, 400));
ย ย ยย
      // Gera a nova sequรชncia mas espera o jogador iniciar
      const newSequence = generateSequence();
      setUserSequence([]);
      setShowSuccess(false);
      setShowError(false);
      playSequence(newSequence);

ย ย }, 2500);
ย }, [sequenceLength, stats, generateSequence, playSequence]);

ย // Falha
ย const handleFailure = useCallback(() => {
ย ย setGameState('fail');
ย ย setShowError(true);
ย ย const newLives = stats.lives - 1;
ย ย setStats(prev => ({ ...prev, lives: newLives, combo: 0 }));
ย ยย
ย ย if (newLives <= 0) {
ย ย ย setTimeout(() => {
ย ย ย ย alert(`Game Over! ๐ฎ Pontuaรงรฃo Final: ${stats.score}`);
ย ย ย ย resetGame();
ย ย ย }, 1000);
ย ย } else {
ย ย ย setTimeout(() => {
ย ย ย ย setShowError(false);
ย ย ย ย playSequence(sequence);
ย ย ย }, 2000);
ย ย }
ย }, [stats, playSequence, sequence]);

ย // Resetar jogo
ย const resetGame = () => {
ย ย setCurrentScreen('titleScreen'); // ATUALIZADO
ย ย setGameState('idle');
ย ย setSequence([]);
ย ย setUserSequence([]);
ย ย setStats(prev => ({
ย ย ย level: 1,
ย ย ย score: 0,
ย ย ย highScore: prev.highScore,
ย ย ย coins: prev.coins,
ย ย ย combo: 0,
ย ย ย lives: 3
ย ย }));
ย ย setSequenceLength(3);
ย ย setPlaybackSpeed(800);
ย };

ย // Repetir sequรชncia
ย const replaySequence = () => {
ย ย if (!isPlaying && gameState === 'playing' && sequence.length > 0) {
ย ย ย setUserSequence([]);
ย ย ย playSequence(sequence);
ย ย }
ย };

  // ===== NOVAS TELAS DE ABERTURA PADRONIZADAS =====

ย // NOVA TELA DE TรTULO
ย const TitleScreen = () => (
ย ย <div className="relative w-full h-screen flex justify-center items-center p-4 bg-gradient-to-br from-purple-400 via-pink-300 to-yellow-300 overflow-hidden">
ย ย ย <div className="relative z-10 flex flex-col items-center text-center">
ย ย ย ย <div className="mb-4">
ย ย ย ย ย <Imageย
ย ย ย ย ย ย src="/images/mascotes/mila/mila_apoio_resultado.webp"
ย ย ย ย ย ย alt="Mila"ย
ย ย ย ย ย ย width={400}ย
ย ย ย ย ย ย height={400}ย
ย ย ย ย ย ย className="w-[280px] h-auto sm:w-[350px] md:w-[400px] drop-shadow-2xl animate-bounce-slow"
ย ย ย ย ย ย priorityย
ย ย ย ย ย />
ย ย ย ย </div>
ย ย ย ย <h1 className="text-5xl sm:text-6xl md:text-7xl font-bold text-purple-800 drop-shadow-lg mb-4">
ย ย ย ย ย Memรณria Sonora
ย ย ย ย </h1>
ย ย ย ย <p className="text-xl sm:text-2xl text-purple-700 mt-2 mb-8 drop-shadow-md">
ย ย ย ย ย Siga a melodia e teste sua memรณria!
ย ย ย ย </p>
ย ย ย ย <buttonย
ย ย ย ย ย onClick={() => setCurrentScreen('instructions')}
ย ย ย ย ย className="text-xl font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 rounded-full px-12 py-5 shadow-xl transition-all duration-300 hover:scale-110 hover:shadow-2xl active:scale-95"
ย ย ย ย >
ย ย ย ย ย Comeรงar
ย ย ย ย </button>
ย ย ย </div>
ย ย </div>
ย );

ย // NOVA TELA DE INSTRUรรES
ย const InstructionsScreen = () => (
ย ย <div className="relative w-full h-screen flex justify-center items-center p-4 bg-gradient-to-br from-blue-300 via-green-300 to-yellow-300">
ย ย ย <div className="bg-white/95 rounded-3xl p-8 max-w-2xl shadow-2xl text-center">
ย ย ย ย <h2 className="text-4xl font-bold mb-6 text-purple-600">
ย ย ย ย ย Como Jogar
ย ย ย ย </h2>
ย ย ย ย <div className="text-lg text-gray-700 space-y-6 mb-8 text-left">
ย ย ย ย ย <p className="flex items-center gap-4">
ย ย ย ย ย ย <span className="text-4xl">๐ง</span>
ย ย ย ย ย ย <span><b>Escute com atenรงรฃo</b> a sequรชncia de sons que a Mila vai tocar.</span>
ย ย ย ย ย </p>
ย ย ย ย ย <p className="flex items-center gap-4">
ย ย ย ย ย ย <span className="text-4xl">๐น</span>
ย ย ย ย ย ย <span><b>Repita a sequรชncia</b> na ordem correta, clicando nos botรตes coloridos.</span>
ย ย ย ย ย </p>
ย ย ย ย ย <p className="flex items-center gap-4">
ย ย ย ย ย ย <span className="text-4xl">๐</span>
ย ย ย ย ย ย <span><b>Acerte para avanรงar de nรญvel</b>, aumentar a dificuldade e ganhar muitos pontos!</span>
ย ย ย ย ย </p>
ย ย ย ย </div>
ย ย ย ย <buttonย
ย ย ย ย ย onClick={startGame}
ย ย ย ย ย className="w-full text-xl font-bold text-white bg-gradient-to-r from-green-500 to-blue-500 rounded-full py-4 shadow-xl transition-all duration-300 hover:scale-105"
ย ย ย ย >
ย ย ย ย ย Entendi, vamos jogar!
ย ย ย ย </button>
ย ย ย </div>
ย ย </div>
ย );
ยย
ย // Tela do Jogo (GameScreen) - Permanece a mesma, apenas renomeada
ย const GameScreen = () => (
ย ย <div id="game-container" className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4 game-container">
ย ย ย <div className="max-w-4xl mx-auto">
ย ย ย ย <div className="bg-white/20 backdrop-blur rounded-2xl p-4 mb-4">
ย ย ย ย ย <div className="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-yellow-300 text-xs font-bold">NรVEL</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl font-bold">{stats.level}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-green-300 text-xs font-bold">PONTOS</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl font-bold">{stats.score}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-orange-300 text-xs font-bold">COMBO</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl font-bold">{stats.combo}x</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-red-300 text-xs font-bold">VIDAS</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl">
ย ย ย ย ย ย ย ย {Array.from({ length: stats.lives }, (_, i) => (
ย ย ย ย ย ย ย ย ย <Heart key={i} className="inline w-5 h-5 text-red-500 fill-red-500" />
ย ย ย ย ย ย ย ย ))}
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-yellow-300 text-xs font-bold">MOEDAS</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl font-bold">๐ฐ {stats.coins}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย <div className="text-purple-300 text-xs font-bold">SEQUรNCIA</div>
ย ย ย ย ย ย ย <div className="text-white text-2xl font-bold">{sequenceLength}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div className="bg-white/10 backdrop-blur rounded-3xl p-6 mb-4">
ย ย ย ย ย <div className="text-center mb-6 min-h-[128px] flex items-center justify-center">
ย ย ย ย ย ย {gameState === 'idle' && (
ย ย ย ย ย ย ย <div className="flex flex-col items-center">
                  <Image src="/images/mascotes/leo/leo_boas_vindas_resultado.webp" alt="Leo" width={100} height={100} />
ย ย ย ย ย ย ย ย <p className="text-white text-xl font-bold">Clique em COMEรAR para jogar!</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย )}
ย ย ย ย ย ย {gameState === 'listening' && (
ย ย ย ย ย ย ย <div className="flex flex-col items-center">
                  <Image src="/images/mascotes/mila/mila_apoio_resultado.webp" alt="Mila" width={100} height={100} />
ย ย ย ย ย ย ย ย <p className="text-yellow-300 text-2xl font-bold animate-pulse">๐ง ESCUTE COM ATENรรO!</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย )}
ย ย ย ย ย ย {gameState === 'playing' && !showSuccess && !showError && (
ย ย ย ย ย ย ย <div className="flex flex-col items-center">
                  <Image src="/images/mascotes/leo/leo_apontando_resultado.webp" alt="Leo" width={100} height={100} />
ย ย ย ย ย ย ย ย <p className="text-green-300 text-2xl font-bold">SUA VEZ! REPITA A SEQUรNCIA!</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย )}
ย ย ย ย ย ย {showSuccess && (
ย ย ย ย ย ย ย <div className="flex flex-col items-center animate-bounce">
                  <Image src="/images/mascotes/leo/leo_joinha_resultado.webp" alt="Leo" width={120} height={120} />
ย ย ย ย ย ย ย ย <p className="text-green-400 text-3xl font-bold">PERFEITO! ๐</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย )}
ย ย ย ย ย ย {showError && (
ย ย ย ย ย ย ย <div className="flex flex-col items-center">
                  <Image src="/images/mascotes/leo/leo_surpreso_resultado.webp" alt="Leo" width={100} height={100} />
ย ย ย ย ย ย ย ย <p className="text-red-400 text-2xl font-bold">OPS! TENTE NOVAMENTE!</p>
ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย )}
ย ย ย ย ย </div>
ย ย ย ย ย <div className="grid grid-cols-3 gap-4 mb-6">
ย ย ย ย ย ย {buttons.map((button, index) => (
ย ย ย ย ย ย ย <button
ย ย ย ย ย ย ย ย key={index}
ย ย ย ย ย ย ย ย id={`btn-${index}`}
ย ย ย ย ย ย ย ย onClick={() => handleNoteClick(index)}
ย ย ย ย ย ย ย ย disabled={gameState !== 'playing' || isPlaying}
ย ย ย ย ย ย ย ย className={`musical-button ${button.color} h-24 md:h-28 rounded-2xl ${gameState === 'listening' && currentNote === index ? 'scale-110 ring-4 ring-white' : ''}`}
ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย <span className="text-3xl">{button.emoji}</span>
ย ย ย ย ย ย ย ย <span className="text-lg font-bold">{button.name}</span>
ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ))}
ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย ย ย <div className="flex justify-center gap-3 flex-wrap">
ย ย ย ย ย {gameState === 'idle' && (
ย ย ย ย ย ย <button onClick={startFirstRound} className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-xl font-bold">
ย ย ย ย ย ย ย <Play className="inline-block mr-2" />
ย ย ย ย ย ย ย COMEรAR
ย ย ย ย ย ย </button>
ย ย ย ย ย )}
ย ย ย ย ย {gameState === 'playing' && (
ย ย ย ย ย ย <button onClick={replaySequence} disabled={isPlaying} className="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-6 py-3 rounded-xl font-bold">
ย ย ย ย ย ย ย <RotateCcw className="inline-block mr-2" />
ย ย ย ย ย ย ย OUVIR NOVAMENTE
ย ย ย ย ย ย </button>
ย ย ย ย ย )}
ย ย ย ย ย <button onClick={resetGame} className="bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-3 rounded-xl font-bold">
ย ย ย ย ย ย MENU
ย ย ย ย ย </button>
ย ย ย ย </div>
ย ย ย </div>
ย ย </div>
ย );

ย // ===== LรGICA DE RENDERIZAรรO ATUALIZADA =====
ย if (currentScreen === 'titleScreen') {
ย ย return <TitleScreen />;
ย }
ย if (currentScreen === 'instructions') {
ย ย return <InstructionsScreen />;
ย }
ย return <GameScreen />;
};

export default AuditoryMemoryGame;
